%% -*- mode: erlang -*-
%%
%% oc_bifrost sys.config file
%%
%% Automatically generated by Chef
%%
[
 {kernel, [{start_pg2, true}]},
 {sasl, [
         {sasl_error_logger, {file, "<%= File.join(@log_dir, 'sasl-error.log') %>"}},
         {errlog_type, error},
         {error_logger_mf_dir, "<%= File.join(@log_dir, 'sasl') %>"},      % Log directory
         {error_logger_mf_maxbytes, 104857600},   % 100 MB max file size
         {error_logger_mf_maxfiles, 5}           % 5 files max
        ]},
 {lager, [
          %% What handlers to install with what arguments
          %% The defaults for the logfiles are to rotate the files when
          %% they reach 10Mb or at midnight, whichever comes first, and keep
          %% the last 5 rotations. See the lager README for a description of
          %% the time rotation format:
          %% https://github.com/basho/lager/blob/master/README.org
          %%
          %% If you wish to disable rotation, you can either set the size to 0
          %% and the rotation time to "", or instead specify a 2-tuple that only
          %% consists of {Logfile, Level}.
          {handlers, [
                      {lager_console_backend, error},
                      {lager_file_backend, [
                                            {file, "<%= File.join(@log_dir, 'error.log') %>"},
                                            {level, error},
                                            %% Disable lager's rotation in favor of logrotate
                                            {size, 0},
                                            {date, ""}
                                           ]},
                      {lager_file_backend, [
                                            {file, "<%= File.join(@log_dir, 'console.log') %>"},
                                            {level, info},
                                            %% Disable lager's rotation in favor of logrotate
                                            {size, 0},
                                            {date, ""},
                                            %% Removes the logging source, since currently
                                            %% there's only one place in all of Bifrost that
                                            %% we log from.  Also removes the PID from
                                            %% the default message format.
                                            {formatter_config, [date, " ", time, " [", severity, "] ", message, "\n"]}
                                           ]}
                     ]},

          %% Whether to write a crash log, and where.
          %% Commented/omitted/undefined means no crash logger.
          {crash_log, "<%= File.join(@log_dir, 'crash.log') %>"},

          %% Maximum size in bytes of events in the crash log - defaults to 65536
          {crash_log_msg_size, 65536},

          %% Maximum size of the crash log in bytes, before its rotated, set
          %% to 0 to disable rotation - default is 0
          {crash_log_size, 10485760},

          %% What time to rotate the crash log - default is no time
          %% rotation. See the lager README for a description of this format:
          %% https://github.com/basho/lager/blob/master/README.org
          {crash_log_date, "$D0"},

          %% Number of rotated crash logs to keep, 0 means keep only the
          %% current one - default is 0
          {crash_log_count, 5},

          %% Whether to redirect error_logger messages into lager - defaults to true
          {error_logger_redirect, true},

          %% Bump up the "high-water mark" (default 50), which is the
          %% number of messages per second allowed to come from
          %% error_logger.  This is the same as used by
          %% opscode-chef-mover, FWIW.
          {error_logger_hwm, 1000}
         ]},
 {webmachine, [
          {log_handlers, [
               {oc_wm_request_logger, [
                       {file, "<%= File.join(@log_dir, 'requests.log') %>"},
                       {file_size, <%= @access_log_mb %>},  %% Size in MB
                       {files, <%= @access_log_count %>},
                         {annotations, [requestor_id, created_authz_id, perf_stats, msg]}
                       ]
                      }]}]
 },
 {sqerl, [
          {db_type, pgsql},
          {db_host, "<%= @db_host %>" },
          {db_port, <%= @db_port %> },
          {db_user, "<%= @db_user %>" },
          {db_pass, "<%= @db_pass %>" },
          {db_name, "<%= @db_name %>" },
          {idle_check, 10000},
          {prepared_statements, {bifrost_db, statements, []} },
          {column_transforms, []}
         ]},
 {stats_hero, [
                {udp_socket_pool_size, <%= @udp_socket_pool_size %> },
                {estatsd_host, "<%= @estatsd_host %>" },
                {estatsd_port, <%= @estatsd_port %> }
               ]},
 {pooler, [
           {pools, [[{name, sqerl},
                     {max_count, <%= @max_pool_size %> },
                     {init_count, <%= @pool_size %> },
                     {start_mfa, {sqerl_client, start_link, []}}]]}
           %%,{metrics_module, folsom_metrics}
          ]},
 {bifrost, [
             {ip, "<%= @ip %>" },
             {port, <%= @port %> },
             {superuser_id, "<%= @superuser_id %>"},
             {root_metric_key, "bifrost"},
             {enable_extended_perf_log, <%= @extended_perf_log %>}
            ]}
].
